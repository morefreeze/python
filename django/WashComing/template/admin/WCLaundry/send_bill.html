{% extends "admin/base_site.html" %}
{% load i18n admin_urls admin_static admin_modify %}

{% block extrahead %}{{ block.super }}
<script type="text/javascript" src="{% url 'admin:jsi18n' %}"></script>

{{ media }}
{% endblock %}

{% block extrastyle %}{{ block.super }}<link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}" />{% endblock %}

{% block coltype %}colM{% endblock %}

{% block bodyclass %}{{ block.super }} app-{{ opts.app_label }} model-{{ opts.model_name }} change-form{% endblock %}

{% if not is_popup %}
{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
&rsaquo; {% if has_change_permission %}<a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>{% else %}{{ opts.verbose_name_plural|capfirst }}{% endif %}
</div>
{% endblock %}
{% endif %}

{% block content %}
<nav role="navigation">
<ul class="nav nav-pills">
    <li class="active" id='to_send-li'>
        <a href="#">待发回</a>
    </li>
    <li id='sent-li'>
        <a href="#">已发订单</a>
    </li>
</ul>
</nav>
<table id="get_bills-tbl">
</table>

<div class="dropdown" id='clothes-dp' style="display:none">
    <button id="dropdown_clothes-btn" class="btn btn-info dropdown-toggle"  type="button" data-toggle="dropdown" aria-expanded="false">
        点击展开衣物信息
        <span class="caret"></span>
    </button>
    <ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="dropdown_clothes-btn">
        <li role="presentation" style="display:none"></li>
    </ul>
</div>
<script>
function get_bills(method, page){
    if ('to_send' != method && 'sent' != method)
        return;
    i_page = parseInt(page || 1)
    ajax_get_bills = jQuery.ajax({
        url: '../../../laundry/get_bills',
        type: 'POST',
        data: {method: method, page: i_page},
    });
    ajax_get_bills.always( function(){
        js_get_bills = JSON.parse(ajax_get_bills.responseText);
        if (!'errno' in js_get_bills || js_get_bills['errno'] != 0){
            bootbox.alert('发生了某些错误，请稍后重试');
            return;
        }
        $('#get_bills-tbl').bootstrapTable('load', js_get_bills['data']);
        if ('to_send' == method){
        }
    });
}
function make_clothes_btn(value, row, index){
    if (!js_get_bills['data'][index]['clothes'])
        return '';
    clothes_dp = $('#clothes-dp[style="display:none"]').clone();
    clothes_ul = clothes_dp.find('ul');
    js_clothes = js_get_bills['data'][index]['clothes'];
    for (clothe_idx in js_clothes){
        it_cloth = js_clothes[clothe_idx];
        clothes_li = clothes_dp.find('li[style="display:none"]').clone();
        clothes_li.text(it_cloth['name'] + ' ￥' + it_cloth['price']
                + '*' + it_cloth['number'] + '件 = ￥' + (it_cloth['price']*it_cloth['number']));
        clothes_li.toggle();
        clothes_ul.append(clothes_li);
    }
    return clothes_dp.html();
}
function make_confirm_btn(value, row, index){
    if ($('li#to_send-li').hasClass('active'))
        return '<button id="confirm_'+row.bid+'-btn"class="btn btn-success btn-success-lg" name="'+row.bid+'">确认送回</button>';
    if ($('li#sent-li').hasClass('active'))
        return '';
        //return '<button id="confirm_'+row.bid+'-btn"class="btn btn-success btn-success-lg" name="'+row.bid+'">修改备注</button>';
}

$('ul.nav.nav-pills li').click( function(){
    s_method = $(this).attr('id');
    s_method = s_method.substring(s_method, s_method.length-3);
    $('ul.nav.nav-pills li').removeClass('active');
    $(this).addClass('active');
    get_bills(s_method);
});
$(document).ready( function(){
    get_bills('to_send');
    $('#get_bills-tbl').bootstrapTable({
        search: true,
        columns: [
        {
            field: 'bid',
            title: '订单号',
            sortable: true,
        },
        {
            field: 'shop_name',
            title: '收到店铺',
        },
        {
            field: 'get_time_0',
            title: '取衣时间',
            sortable: true,
            searchable: false,
        },
        {
            field: 'return_time_0',
            title: '送衣时间',
            sortable: true,
            searchable: false,
        },
        {
            field: 'real_name',
            title: '客户姓名',
        },
        {
            field: 'phone',
            title: '客户电话',
        },
        {
            field: 'address',
            title: '客户地址',
        },
        {
            field: 'shop_comment',
            title: '店铺备注（洗后效果加在这里）',
            editable: {
                type: 'textarea',
            },
        },
        {
            field: 'total',
            title: '总价',
            sortable: true,
            formatter: function(value, row, index){ return '￥'+value; },
            searchable: false,
        },
        {
            field: 'clothes',
            title: '衣物详情',
            searchable: false,
            formatter: make_clothes_btn,
        },
        {
            field: 'operate',
            title: '操作',
            searchable: false,
            formatter: make_confirm_btn,
        },
        ],
    });

});

$(s_method = 'table#get_bills-tbl').on('click', 'button[id^=confirm]', function(){
    s_bid = $(this).attr('name');
    s_shop_comment = $(this).parents('tr').find('[data-name=shop_comment]').text() || ''
    ajax_confirm_return = jQuery.ajax({
        url: '../../../laundry/confirm_return',
        type: 'POST',
        data: {bid: s_bid, shop_comment: s_shop_comment,},
    });
    ajax_confirm_return.always( function(){
        js_confirm_return = JSON.parse(ajax_confirm_return.responseText);
        if (!'errno' in js_confirm_return || js_confirm_return['errno'] != 0){
            bootbox.alert('发生了某些错误，请稍后重试');
            return;
        }
        bootbox.alert('确认送回成功！请稍后在已发订单中查看送回受理单号。');
        s_method = $('ul.nav.nav-pills li.active').attr('id');
        s_method = s_method.substring(s_method, s_method.length-3);
        get_bills(s_method);
    });
});
</script>
<style>
li[role=presentation]{
    font-size: 24px;
    line-height: 38px;
}

</style>
{% endblock %}
